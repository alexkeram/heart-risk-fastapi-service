# Heart Risk Classification

–í–µ–±‚Äë—Å–µ—Ä–≤–∏—Å –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞ —Ä–∏—Å–∫–∞ —Å–µ—Ä–¥–µ—á–Ω–æ–≥–æ –ø—Ä–∏—Å—Ç—É–ø–∞.

–ü—Ä–æ–µ–∫—Ç –≤–∫–ª—é—á–∞–µ—Ç:
- –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –Ω–æ—É—Ç–±—É–∫ (EDA + –æ–±—É—á–µ–Ω–∏–µ, –≤—ã–±–æ—Ä –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏),
- –±–∏–±–ª–∏–æ—Ç–µ–∫—É (`src/`) —Å –∫–ª–∞—Å—Å–∞–º–∏ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏/–æ–±—É—á–µ–Ω–∏—è/–∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞,
- –≤–µ–±‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ FastAPI (`app/`) –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ CSV –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π,
- –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –≤ `artifacts/` (–¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è).

---

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∏ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –≤—Ö–æ–¥–Ω–æ–≥–æ CSV (`EDAAnalyzer`);
- –û–±—É—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π —Å –∫—Ä–æ—Å—Å‚Äë–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –≤—ã–±–æ—Ä –ª—É—á—à–µ–π –ø–æ F‚ÄëŒ≤ (`HeartRiskRunner` / `HeartRiskJob`);
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –º–æ–¥–µ–ª–∏ (–º–µ—Ç–∞ + —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏);
- –õ–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω—Ñ–µ—Ä–µ–Ω—Å –≤ –∫–æ–¥–µ/–Ω–æ—É—Ç–±—É–∫–µ (`HeartRiskInference`);
- –í–µ–±‚Äë–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π (–∑–∞–≥—Ä—É–∑–∫–∞/—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ CSV) **–∏** JSON‚ÄëAPI.
- –í—ã–¥–∞—á–∞ –ø–æ API –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON

**–§–æ—Ä–º–∞—Ç –≤—ã–¥–∞—á–∏:** CSV —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏  
`patient_id`, `proba`, `prediction` (0 ‚Äî –Ω–∏–∑–∫–∏–π —Ä–∏—Å–∫, 1 ‚Äî –≤—ã—Å–æ–∫–∏–π).

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```
.
‚îú‚îÄ app/                      # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ  ‚îú‚îÄ static/                # —Å—Ç–∏–ª–∏
‚îÇ  ‚îú‚îÄ templates/             # Jinja2 (index.html)
‚îÇ  ‚îî‚îÄ main.py                # —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ artifacts/                # –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ (best_meta.json, best_model.*)
‚îú‚îÄ data/                     # (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚îú‚îÄ notebooks/
‚îÇ  ‚îî‚îÄ heart_risk_notebook.ipynb
‚îú‚îÄ src/                      # –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (–û–û–ü)
‚îÇ  ‚îú‚îÄ eda_analyzer.py
‚îÇ  ‚îú‚îÄ heart_runner.py
‚îÇ  ‚îú‚îÄ heart_job.py
‚îÇ  ‚îú‚îÄ inference_utils.py
‚îÇ  ‚îî‚îÄ quick_view.py
‚îú‚îÄ requirements.txt
‚îî‚îÄ README.md / README.txt
```

---

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# 1) —Å–æ–∑–¥–∞—Ç—å –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
python -m venv .venv
# Windows:
.venv\Scripts\activate
# macOS/Linux:
# source .venv/bin/activate

# 2) —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt
```

> –ú–∏–Ω–∏–º—É–º: `pandas`, `numpy`, `scikit-learn`, `catboost`, `shap`,
> `fastapi`, `uvicorn`, `joblib`, `nest-asyncio` (–¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–∑ Jupyter).

---

## üß™ –û–±—É—á–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (–≤ –Ω–æ—É—Ç–±—É–∫–µ)

```python
from pathlib import Path
import pandas as pd
from src.heart_job import HeartRiskJob, RunCfg

# –¥–∞–Ω–Ω—ã–µ
train_df = pd.read_csv(Path("data") / "heart_train.csv")

# –∑–∞–ø—É—Å–∫ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –≤ ./artifacts
job = HeartRiskJob(RunCfg(), artifacts_dir=Path("artifacts"))
meta = job.run_and_save(train_df)
meta
```
–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ `artifacts/` –ø–æ—è–≤—è—Ç—Å—è:
- `best_meta.json` ‚Äî –º–µ—Ç–∞‚Äë–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è,
- `best_model.cbm` **–∏–ª–∏** `best_model.joblib` ‚Äî —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏.

---

## üîç –ò–Ω—Ñ–µ—Ä–µ–Ω—Å –≤ –∫–æ–¥–µ / –Ω–æ—É—Ç–±—É–∫–µ

```python
import pandas as pd
from src.inference_utils import HeartRiskInference

inf = HeartRiskInference.from_dir()  # –≤—Å–µ–≥–¥–∞ –±–µ—Ä—ë—Ç –∏–∑ ./artifacts
df_test = pd.read_csv("data/heart_test.csv")

preds = inf.predict(df_test)         # DataFrame: proba, prediction
print(preds.head())

# —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤
dist = preds["prediction"].value_counts().to_dict()
print("–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ (0):", dist.get(0, 0))
print("–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ (1):", dist.get(1, 0))
```

---

## üåê –í–µ–±‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (FastAPI)

### –ó–∞–ø—É—Å–∫ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏

```bash
uvicorn app.main:app --host 127.0.0.1 --port 8000
```
- –û—Ç–∫—Ä–æ–π—Ç–µ: http://127.0.0.1:8000  
- –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV  
- –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
- –°–∫–∞—á–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (CSV)

### –ó–∞–ø—É—Å–∫ –ø—Ä—è–º–æ –∏–∑ Jupyter Notebook
```python
import nest_asyncio, uvicorn
nest_asyncio.apply()
uvicorn.run("app.main:app", host="127.0.0.1", port=8000, reload=False)
```

---

## üîå JSON‚ÄëAPI (—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã)

–ë–∞–∑–æ–≤—ã–π URL: `http://127.0.0.1:8000`

### 1) Check: `GET /health`
–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.
```bash
curl http://127.0.0.1:8000/health
```
–û—Ç–≤–µ—Ç:
```json
{"status": "ok", "version": "<hash>"}
```

### 2) –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø–æ –ø—É—Ç–∏ –∫ CSV: `POST /api/predict`
Request body:
```json
{ "path": "data/heart_test.csv" }
```

–ü—Ä–∏–º–µ—Ä (bash/PowerShell):
```bash
curl -X POST http://127.0.0.1:8000/api/predict ^
  -H "Content-Type: application/json" ^
  -d "{ \"path\": \"data/heart_test.csv\" }"
```
–û—Ç–≤–µ—Ç (–ø—Ä–∏–º–µ—Ä):
```json
{
  "summary": {
    "n_patients": 1000,
    "n_high": 123, "p_high": 12.3,
    "n_low": 877,  "p_low": 87.7
  },
  "predictions": [
    {"patient_id": 0, "proba": 0.812, "prediction": 1},
    {"patient_id": 1, "proba": 0.132, "prediction": 0}
  ]
}
```

### 3) –°–∫–∞—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (CSV): `GET /download`
–û—Ç–¥–∞—ë—Ç —Ñ–∞–π–ª `predictions.csv` (–∫–æ–ª–æ–Ω–∫–∏: `patient_id,proba,prediction`) ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ (—á–µ—Ä–µ–∑ –≤–µ–±‚Äë—Ñ–æ—Ä–º—É –∏–ª–∏ `/api/predict`).

---

## üóÇÔ∏è –ü–∞–ø–∫–∞ `artifacts/`

–û–∂–∏–¥–∞—é—Ç—Å—è –¥–≤–∞ —Ñ–∞–π–ª–∞:
- `best_meta.json`
- `best_model.cbm` **–∏–ª–∏** `best_model.joblib`

---

## üß© –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã (src/)

- **`EDAAnalyzer`** ‚Äî –æ—á–∏—Å—Ç–∫–∞/–ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤/–∏–º–ø—É—Ç–∞—Ü–∏–∏ + –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å train/test.
- **`HeartRiskRunner`** ‚Äî CV –¥–ª—è CatBoost / HistGB / RF, –ø–æ–¥–±–æ—Ä –ø–æ—Ä–æ–≥–∞ F‚ÄëŒ≤, –±—É—Ç—Å—Ç—Ä–µ–ø‚Äë–î–ò, SHAP‚Äë—Ç–æ–ø.
- **`HeartRiskJob`** ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä: `run()` (–æ–±—É—á–µ–Ω–∏–µ + –æ—Ç—á—ë—Ç), `save()` (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã), `run_and_save()`.
- **`HeartRiskInference`** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (`predict_proba`, `predict`, `class_distribution`).
- **`QuickView`** ‚Äî –±—ã—Å—Ç—Ä—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏/—Å–≤–æ–¥–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).

---

## ‚úÖ –ß—Ç–æ —Å–¥–∞—ë—Ç—Å—è

- –ù–æ—É—Ç–±—É–∫ —Å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º –∏ –æ–±—É—á–µ–Ω–∏–µ–º;
- –ö–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (`src/`, `app/`);
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É (—ç—Ç–æ—Ç README);
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å: `requirements.txt`.
